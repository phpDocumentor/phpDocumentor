<?php
error_reporting(E_ALL & ~E_STRICT & ~E_DEPRECATED);
require_once('PEAR/PackageFileManager2.php');
PEAR::setErrorHandling(PEAR_ERROR_DIE);

function createPackager($path, $template, $options = array())
{
  $settings = simplexml_load_file($path . '/template.xml');
  $version     = (string)$settings->version;
  $author      = (string)$settings->author;
  $description = (string)$settings->description;
  $email       = (string)$settings->email;

  // merge the options with these defaults.
  $options = array_merge(array(
    'packagefile'       => 'package.xml',
    'filelistgenerator' => 'file',
    'simpleoutput'      => true,
    'baseinstalldir'    => '/DocBlox/data/templates/' . $template,
    'packagedirectory'  => $path,
    'clearcontents'     => true,
    'ignore'            => array(),
    'exceptions'        => array(),
    'installexceptions' => array(),
    'dir_roles'         => array(
      '/'   => 'php', // explicitly set the role to php to allowthe templates to
        // installed inside the DocBlox PEAR folder. This will help keep
        // everything together
    ),
  ), $options);

  $packagexml = PEAR_PackageFileManager2::importOptions(
      '', $options
  );
  $packagexml->setPackageType('php');

  $packagexml->setPackage('DocBlox_Template_' . $template);
  $packagexml->setSummary('The ' . $template . ' template for DocBlox');
  $packagexml->setDescription($description);
  $packagexml->setChannel('pear.docblox-project.org');
  $packagexml->setNotes('Automatically generated by the DocBlox packager');

  $packagexml->setPhpDep('5.2.6');
  $packagexml->setPearinstallerDep('1.4.0');
  $packagexml->addPackageDepWithChannel('required', 'PEAR', 'pear.php.net', '1.4.0');
  $packagexml->addPackageDepWithChannel('required', 'DocBlox', 'pear.docblox-project.org', '0.17.0');

  $packagexml->addMaintainer('lead', '', $author, $email);
  $packagexml->setLicense('MIT', 'http://www.opensource.org/licenses/mit-license.html');

  // Add this as a release, and generate XML content
  $packagexml->addRelease();

  $packagexml->setAPIVersion($version);
  $packagexml->setReleaseVersion($version);
  $packagexml->setReleaseStability('stable');
  $packagexml->setAPIStability('stable');

  return $packagexml;
}


echo 'DocBlox PEAR template Packager v1.0'.PHP_EOL;

if ($argc < 2)
{
  echo <<<HELP

Usage:
  php package.php [path] [template] [make|nothing]

Description:
  The DocBlox packager generates a package.xml file and accompanying package.

  A file will only be generated if the third parameter is the word 'make'; otherwise the output will be send to
  the command line.

HELP;
  exit(0);
}

$packager = createPackager($argv[1], $argv[2]);
$packager->generateContents();
if (isset($argv[3]) && ($argv[3] == 'make')) {
  $packager->writePackageFile();
} else {
  $packager->debugPackageFile();
}
